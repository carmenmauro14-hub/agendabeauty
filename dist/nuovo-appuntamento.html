// nuovo-appuntamento.js

// â”€â”€â”€ Firebase: riuso dell'app inizializzata in auth.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { db } from "./auth.js";
import {
  collection, getDocs, addDoc, updateDoc, getDoc, doc, Timestamp,
  query, where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { abilitaSwipeVerticale } from "./swipe.js";
import { putOne } from "./storage.js";   // ðŸ”¥ salvataggio in cache offline

// â”€â”€â”€ Parametri URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const urlParams        = new URLSearchParams(location.search);
const editId           = urlParams.get("edit");
const presetClienteId  = urlParams.get("cliente");
const presetDataISO    = urlParams.get("data");

// â”€â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wizardTitle        = document.getElementById("wizardTitle");
const step1              = document.getElementById("step1");
const step2              = document.getElementById("step2");
const step3              = document.getElementById("step3");

const btnToStep2         = document.getElementById("toStep2");
const btnBackToStep1     = document.getElementById("backToStep1");
const btnToStep3         = document.getElementById("toStep3");
const btnBackToStep2     = document.getElementById("backToStep2");
const btnSalva           = document.getElementById("salvaAppuntamento");
const btnCancel          = document.getElementById("cancelWizard");

const inpData            = document.getElementById("dataAppuntamento");
const inpOra             = document.getElementById("oraAppuntamento");
const wrapperTratt       = document.getElementById("trattamentiWrapper");

const clienteIdHidden    = document.getElementById("clienteId");
const pickerValue        = document.getElementById("pickerValue");
const pickerPlaceholder  = document.getElementById("pickerPlaceholder");
const openRubricaField   = document.getElementById("openRubricaField");

// â”€â”€â”€ Stato â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apptData = null;

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPageTitle(text) {
  if (wizardTitle) wizardTitle.textContent = text;
  document.title = text;
}

// â”€â”€â”€ Navigazione step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnToStep2?.addEventListener("click", () => {
  if (!clienteIdHidden.value) return alert("Seleziona un cliente");
  step1.style.display = "none";
  step2.style.display = "block";
});
btnBackToStep1?.addEventListener("click", () => {
  step2.style.display = "none";
  step1.style.display = "block";
});
btnToStep3?.addEventListener("click", () => {
  if (!(inpData.value && inpOra.value)) return alert("Inserisci data e ora");
  step2.style.display = "none";
  step3.style.display = "block";
});
btnBackToStep2?.addEventListener("click", () => {
  step3.style.display = "none";
  step2.style.display = "block";
});

// â”€â”€â”€ Salvataggio appuntamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnSalva?.addEventListener("click", async () => {
  const clienteId = clienteIdHidden.value;
  const dataISO   = inpData.value;
  const ora       = inpOra.value;

  if (!clienteId) return alert("Seleziona un cliente");
  if (!(dataISO && ora)) return alert("Inserisci data e ora");

  const selected = [...document.querySelectorAll(".trattamento-checkbox:checked")];
  if (!selected.length) return alert("Seleziona almeno un trattamento");

  const trattamenti = selected.map(cb => {
    const row = cb.closest(".trattamento-row");
    const prezzoInput = row.querySelector(".prezzo-input");
    const prezzoVal = parseFloat(prezzoInput.value);
    return {
      nome: cb.dataset.nome,
      prezzo: Number.isFinite(prezzoVal) ? prezzoVal : 0,
      icona: cb.dataset.icona
    };
  });

  const dateMidnight = new Date(dataISO + "T00:00:00");
  const dataTs = Timestamp.fromDate(dateMidnight);

  const [hh, mm] = ora.split(":").map(n => parseInt(n, 10));
  const dateWithTime = new Date(dateMidnight);
  dateWithTime.setHours(hh || 0, mm || 0, 0, 0);
  const dateTime = Timestamp.fromDate(dateWithTime);

  // Oggetto appuntamento da salvare anche offline
  const docData = {
    clienteId,
    data: dataTs,
    dataISO,
    ora,
    dateTime,
    trattamenti
  };

  try {
    if (editId) {
      await updateDoc(doc(db, "appuntamenti", editId), docData);
      await putOne("appuntamenti", { id: editId, ...docData }); // ðŸ”¥ cache offline
      alert("Appuntamento aggiornato!");
    } else {
      const ref = await addDoc(collection(db, "appuntamenti"), docData);
      await putOne("appuntamenti", { id: ref.id, ...docData }); // ðŸ”¥ cache offline
      alert("Appuntamento salvato con successo!");
    }
    location.href = "calendario.html";
  } catch (err) {
    console.error("Errore salvataggio:", err);
    alert("Errore durante il salvataggio.");
  }
});

// â”€â”€â”€ Avvio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  setPageTitle(editId ? "Modifica Appuntamento" : "Nuovo Appuntamento");

  if (!editId && presetDataISO && inpData) {
    inpData.value = presetDataISO;
  }

  btnCancel?.addEventListener("click", () => {
    if (history.length > 1) history.back();
    else location.href = "calendario.html";
  });
})();